<div
  id="kt_activities"
  class="bg-body"
  data-kt-drawer="true"
  data-kt-drawer-name="activities"
  data-kt-drawer-activate="true"
  data-kt-drawer-overlay="true"
  data-kt-drawer-width="{default:'300px', 'lg': '900px'}"
  data-kt-drawer-direction="end"
  data-kt-drawer-toggle="#kt_activities_toggle"
  data-kt-drawer-close="#kt_activities_close"
>
  <div class="card shadow-none rounded-0">
    <!-- Header -->
    <div class="card-header" id="kt_activities_header">
      <h3 class="card-title fw-bolder text-gray-900">
        Registro de Actividades
        <span class="fs-7 text-muted ms-2">({{ activities.length }} actividades)</span>
      </h3>

      <div class="card-toolbar">
        <!-- Botón de refrescar -->
        <button
          type="button"
          class="btn btn-sm btn-icon btn-active-light-primary me-2"
          (click)="refresh()"
          [disabled]="isLoading"
          title="Refrescar"
        >
          <app-keenicon 
            name="arrows-circle" 
            class="fs-1"
            [ngClass]="{'spinner-border spinner-border-sm': isLoading}"
          ></app-keenicon>
        </button>

        <!-- Botón de cerrar -->
        <button
          type="button"
          class="btn btn-sm btn-icon btn-active-light-primary me-n5"
          id="kt_activities_close"
        >
          <app-keenicon name="cross" class="fs-1"></app-keenicon>
        </button>
      </div>
    </div>

    <!-- Body -->
    <div class="card-body position-relative" id="kt_activities_body">
      <!-- Loading -->
      <div *ngIf="isLoading" class="text-center py-10">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="text-muted mt-3">Cargando actividades...</p>
      </div>

      <!-- Error -->
      <div *ngIf="error && !isLoading" class="alert alert-danger">
        <app-keenicon name="information-5" class="fs-2 me-2"></app-keenicon>
        {{ error }}
      </div>

      <!-- Sin actividades -->
      <div *ngIf="!isLoading && activities.length === 0 && !error" class="text-center py-10">
        <app-keenicon name="file-deleted" class="fs-3x text-muted mb-5"></app-keenicon>
        <p class="text-muted fs-4 fw-bold">No hay actividades recientes</p>
        <p class="text-gray-600">Las actividades de tus proyectos aparecerán aquí</p>
      </div>

      <!-- Lista de actividades -->
      <div
        *ngIf="!isLoading && activities.length > 0"
        id="kt_activities_scroll"
        class="position-relative scroll-y me-n5 pe-5"
        data-kt-scroll="true"
        data-kt-scroll-height="auto"
        data-kt-scroll-wrappers="#kt_activities_body"
        data-kt-scroll-dependencies="#kt_activities_header, #kt_activities_footer"
        data-kt-scroll-offset="5px"
      >
        <div class="timeline">
          <!-- Activity Item -->
          <div *ngFor="let activity of activities; let isLast = last" class="timeline-item">
            <div class="timeline-line w-40px" [ngClass]="{'d-none': isLast}"></div>

            <!-- Icon -->
            <div class="timeline-icon symbol symbol-circle symbol-40px me-4">
              <div class="symbol-label" [ngClass]="getIconClass(activity)">
                <app-keenicon 
                  [name]="activity.icon" 
                  class="fs-2"
                  [ngClass]="'text-' + activity.color"
                ></app-keenicon>
              </div>
            </div>

            <!-- Content -->
            <div class="timeline-content mb-10 mt-n1">
              <!-- User info -->
              <div class="d-flex align-items-center mb-3">
                <div class="symbol symbol-circle symbol-35px me-3">
                  <img [src]="activity.user.avatar" [alt]="activity.user.name" />
                </div>
                <div class="flex-grow-1">
                  <span class="fw-bold text-gray-900 fs-6">{{ activity.user.name }}</span>
                  <span class="text-gray-600 fs-7 ms-2">{{ getActivityDescription(activity) }}</span>
                </div>
              </div>

              <!-- Tarea info (si existe) -->
              <div 
                *ngIf="activity.tarea" 
                class="d-flex align-items-center border border-dashed border-gray-300 rounded px-5 py-3 mb-3 cursor-pointer hover-elevate-up"
                (click)="goToTarea(activity.tarea.id)"
              >
                <app-keenicon name="check-square" class="fs-2 text-primary me-3"></app-keenicon>
                <div class="flex-grow-1">
                  <span class="text-gray-800 fw-bold">{{ activity.tarea.title }}</span>
                </div>
                <span class="badge" [ngClass]="'badge-light-' + activity.color">
                  {{ getActivityTypeText(activity.type) }}
                </span>
              </div>

              <!-- Metadata (si existe) -->
              <div *ngIf="activity.metadata && Object.keys(activity.metadata).length > 0" class="mb-3">
                <div *ngFor="let key of Object.keys(activity.metadata)" class="text-gray-600 fs-7">
                  <span class="fw-bold">{{ key }}:</span> {{ activity.metadata[key] }}
                </div>
              </div>

              <!-- Timestamp -->
              <div class="d-flex align-items-center">
                <app-keenicon name="time" class="fs-7 text-muted me-1"></app-keenicon>
                <span 
                  class="text-muted fs-7" 
                  [title]="activity.created_at_full"
                >
                  {{ activity.created_at }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div 
      *ngIf="!isLoading && activities.length > 0" 
      class="card-footer py-5 text-center" 
      id="kt_activities_footer"
    >
      <button 
        class="btn btn-bg-body text-primary"
        (click)="refresh()"
      >
        Cargar más actividades
        <app-keenicon name="arrow-down" class="fs-3 ms-2"></app-keenicon>
      </button>
    </div>
  </div>
</div>
