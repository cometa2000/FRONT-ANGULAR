<!-- ========================================
     ðŸ“‹ VISTA DE GRUPOS POR WORKSPACE (PAGINADA)
     âœ… PROBLEMAS 1, 2 y 3 SOLUCIONADOS
     ======================================== -->
<div class="card">
  
  <!-- âœ… Breadcrumb - InformaciÃ³n del Workspace -->
  <div class="card-header border-0 pt-6 pb-3" *ngIf="workspace">
    <div class="d-flex align-items-center gap-3 mb-3">
      <!-- Icono del workspace -->
      <div 
        class="symbol symbol-50px"
        [style.background-color]="workspace.color || '#6366f1'"
        style="border-radius: 8px;"
      >
        <i 
          class="ki-duotone ki-folder fs-2x text-white"
          style="display: flex; align-items: center; justify-content: center; height: 100%;"
        >
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
      </div>
      
      <!-- Info del workspace -->
      <div class="flex-grow-1">
        <h2 class="mb-1">{{ workspace.name }}</h2>
        <p class="text-muted mb-0 fs-7" *ngIf="workspace.description">
          {{ workspace.description }}
        </p>
        <p class="text-muted mb-0 fs-8 mt-1">
          <i class="ki-duotone ki-folder fs-7 me-1">
            <span class="path1"></span>
            <span class="path2"></span>
          </i>
          {{ totalItems }} grupo(s) total
        </p>
      </div>
      
      <!-- BotÃ³n volver -->
      <a 
        routerLink="/tasks/workspaces/list" 
        class="btn btn-sm btn-light-primary"
      >
        <i class="ki-duotone ki-arrow-left fs-4 me-1">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        Volver a Espacios
      </a>
    </div>
  </div>

  <!-- ðŸ” Barra de bÃºsqueda y acciones -->
  <div class="card-header border-0 pt-3">
    <div class="card-title">
      <div class="d-flex align-items-center position-relative my-1">
        <i class="ki-duotone ki-magnifier fs-1 position-absolute ms-6">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        <input 
          type="text" 
          class="form-control form-control-solid w-250px ps-15" 
          placeholder="Buscar grupos..."
          [(ngModel)]="search"
          (keyup.enter)="listGruposByWorkspace()"
        />
      </div>
    </div>

    <div class="card-toolbar">
      <button 
        type="button" 
        class="btn btn-primary"
        (click)="createGrupo()"
      >
        <i class="ki-duotone ki-plus fs-2"></i>
        Nuevo Grupo
      </button>
    </div>
  </div>

  <!-- ðŸ“‹ Lista de Grupos -->
  <div class="card-body pt-0">
    
    <!-- â³ Loading State -->
    <div *ngIf="isLoading$ | async" class="text-center py-10">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="text-muted mt-3">Cargando grupos...</p>
    </div>

    <!-- ðŸ“‚ Grid de Grupos PAGINADO -->
    <div *ngIf="!(isLoading$ | async)" class="grupos-grid-modern">
      
      <!-- ðŸ—‚ï¸ Tarjeta de Grupo - Iterar sobre paginatedGrupos -->
      <!-- âœ… SOLUCIÃ“N PROBLEMA 3: Click con evento para verificar -->
      <div 
        *ngFor="let grupo of paginatedGrupos" 
        class="grupo-card-modern"
        (click)="goToTablero(grupo.id, $event)"
      >
        <div 
          class="grupo-card-bg"
          [style.background-image]="'url(' + getGrupoImageUrl(grupo.image) + ')'"
        ></div>
        
        <div class="grupo-card-content">
          
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <h5 class="grupo-card-title text-white mb-1">
                {{ grupo.name }}
              </h5>
              
              <span 
                *ngIf="grupo.is_owner" 
                class="badge badge-light-primary fs-8"
              >
                <i class="ki-duotone ki-user fs-6 me-1">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                Propietario
              </span>
            </div>
            
            <!-- âœ… SOLUCIÃ“N PROBLEMA 1 y 3: Opciones con fixed position -->
            <div class="grupo-options-modern">
              <button 
                class="btn btn-sm btn-icon btn-active-light-primary"
                (click)="toggleMenu(grupo.id, $event)"
                style="background: rgba(255,255,255,0.2);"
              >
                <i class="ki-duotone ki-dots-vertical fs-3 text-white">
                  <span class="path1"></span>
                  <span class="path2"></span>
                  <span class="path3"></span>
                </i>
              </button>

              <!-- MenÃº con position: fixed -->
              <div 
                class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-200px py-4"
                [class.show]="openMenuId === grupo.id"
              >
                <!-- âœ… SOLUCIÃ“N PROBLEMA 3: Pasar $event -->
                <div class="menu-item px-3">
                  <a class="menu-link px-3" (click)="closeMenuAnd('marcarGrupo', grupo, $event)">
                    <i class="ki-duotone ki-star fs-5 me-2" [class.text-warning]="grupo.is_starred">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                    {{ grupo.is_starred ? 'Desmarcar' : 'Marcar' }}
                  </a>
                </div>
                
                <div class="menu-item px-3">
                  <a class="menu-link px-3" (click)="closeMenuAnd('shareGrupo', grupo, $event)">
                    <i class="ki-duotone ki-share fs-5 me-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                    Compartir
                  </a>
                </div>
                
                <div class="menu-item px-3" *ngIf="grupo.is_owner">
                  <a class="menu-link px-3" (click)="closeMenuAnd('configPermisos', grupo, $event)">
                    <i class="ki-duotone ki-lock fs-5 me-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                      <span class="path3"></span>
                    </i>
                    Configurar permisos
                  </a>
                </div>
                
                <div class="separator my-2"></div>
                
                <div class="menu-item px-3">
                  <a class="menu-link px-3" (click)="closeMenuAnd('editGrupo', grupo, $event)">
                    <i class="ki-duotone ki-pencil fs-5 me-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                    Editar grupo
                  </a>
                </div>
                
                <div class="menu-item px-3" *ngIf="grupo.is_owner">
                  <a class="menu-link px-3 text-danger" (click)="closeMenuAnd('deleteGrupo', grupo, $event)">
                    <i class="ki-duotone ki-trash fs-5 me-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                      <span class="path3"></span>
                      <span class="path4"></span>
                      <span class="path5"></span>
                    </i>
                    Eliminar grupo
                  </a>
                </div>
              </div>
            </div>
          </div>
          
          <div class="grupo-info-owner mb-3">
            <div class="d-flex align-items-center gap-2">
              <div class="symbol symbol-25px symbol-circle">
                <img 
                  [src]="getAvatarUrl(grupo.user?.avatar)" 
                  [alt]="grupo.user?.name"
                />
              </div>
              <span class="text-white fs-7 opacity-75">
                {{ grupo.user?.name || 'Usuario' }}
              </span>
            </div>
          </div>
          
          <div class="grupo-card-footer">
            <div class="d-flex align-items-center gap-2">
              <div class="symbol symbol-25px symbol-circle">
                <img 
                  [src]="getAvatarUrl(grupo.user?.avatar)" 
                  alt="Owner"
                />
              </div>
              
              <div class="symbol-group symbol-hover" *ngIf="grupo.shared_with && grupo.shared_with.length > 0">
                <div 
                  *ngFor="let member of grupo.shared_with.slice(0, 3)" 
                  class="symbol symbol-25px symbol-circle"
                >
                  <img 
                    [src]="getAvatarUrl(member.avatar)" 
                    [alt]="member.name"
                  />
                </div>
                
                <span 
                  *ngIf="grupo.shared_with.length > 3" 
                  class="symbol symbol-25px symbol-circle"
                >
                  <span class="symbol-label bg-light text-gray-600 fs-8">
                    +{{ grupo.shared_with.length - 3 }}
                  </span>
                </span>
              </div>
            </div>
            
            <div *ngIf="grupo.is_starred">
              <i class="ki-duotone ki-star fs-3 text-warning">
                <span class="path1"></span>
                <span class="path2"></span>
              </i>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- âœ… SOLUCIÃ“N PROBLEMA 2: PaginaciÃ³n -->
    <div 
      *ngIf="!(isLoading$ | async) && totalPages > 1" 
      class="d-flex justify-content-center align-items-center mt-8 flex-wrap gap-3"
    >
      <ul class="pagination mb-0">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" (click)="goToPage(1)" style="cursor: pointer;">
            <i class="ki-duotone ki-double-left fs-5">
              <span class="path1"></span>
              <span class="path2"></span>
            </i>
          </a>
        </li>
        
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" (click)="goToPage(currentPage - 1)" style="cursor: pointer;">
            <i class="ki-duotone ki-left fs-5">
              <span class="path1"></span>
              <span class="path2"></span>
            </i>
          </a>
        </li>
        
        <li 
          *ngFor="let page of getPages()" 
          class="page-item" 
          [class.active]="currentPage === page"
        >
          <a class="page-link" (click)="goToPage(page)" style="cursor: pointer;">
            {{ page }}
          </a>
        </li>
        
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <a class="page-link" (click)="goToPage(currentPage + 1)" style="cursor: pointer;">
            <i class="ki-duotone ki-right fs-5">
              <span class="path1"></span>
              <span class="path2"></span>
            </i>
          </a>
        </li>
        
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <a class="page-link" (click)="goToPage(totalPages)" style="cursor: pointer;">
            <i class="ki-duotone ki-double-right fs-5">
              <span class="path1"></span>
              <span class="path2"></span>
            </i>
          </a>
        </li>
      </ul>
      
      <div class="text-muted fs-7">
        Mostrando {{ (currentPage - 1) * itemsPerPage + 1 }}-{{ Math.min(currentPage * itemsPerPage, totalItems) }} de {{ totalItems }} grupos
      </div>
    </div>

    <!-- ðŸ”­ Mensaje cuando no hay grupos -->
    <div 
      *ngIf="!(isLoading$ | async) && GRUPOS.length === 0"
      class="text-center py-20"
    >
      <i class="ki-duotone ki-folder fs-5x text-gray-300 mb-4">
        <span class="path1"></span>
        <span class="path2"></span>
      </i>
      <h3 class="text-gray-700 mb-2">No hay grupos en este espacio</h3>
      <p class="text-gray-500 mb-5">Comienza creando tu primer grupo</p>
      <button 
        class="btn btn-primary"
        (click)="createGrupo()"
      >
        <i class="ki-duotone ki-plus fs-2 me-1">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        Crear Grupo
      </button>
    </div>

  </div>
</div>