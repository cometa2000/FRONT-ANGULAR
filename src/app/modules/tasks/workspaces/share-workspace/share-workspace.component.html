<!-- ========================================
     üì§ VISTA DE GRUPOS COMPARTIDOS CONMIGO
     ======================================== -->
<div class="card">
  <!-- üîç Barra de b√∫squeda -->
  <div class="card-header border-0 pt-6">
    <div class="card-title">
      <div class="d-flex align-items-center position-relative my-1">
        <i class="ki-duotone ki-magnifier fs-1 position-absolute ms-6">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        <input 
          type="text" 
          class="form-control form-control-solid w-250px ps-15" 
          placeholder="Buscar grupos compartidos..."
          [(ngModel)]="search"
          (keyup.enter)="searchGrupos()"
        />
      </div>
    </div>

    <div class="card-toolbar">
      <div class="d-flex align-items-center gap-2">
        <span class="badge badge-light-primary fs-7">
          <i class="ki-duotone ki-share fs-4 me-1">
            <span class="path1"></span>
            <span class="path2"></span>
          </i>
          {{ SHARED_GRUPOS.length }} grupo(s) compartido(s)
        </span>
      </div>
    </div>
  </div>

  <!-- üìã Lista de Grupos Compartidos -->
  <div class="card-body pt-0">
    
    <!-- ‚è≥ Loading State -->
    <div *ngIf="isLoading$ | async" class="text-center py-10">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="text-muted mt-3">Cargando grupos compartidos...</p>
    </div>

    <!-- üìÇ Container de grupos -->
    <div *ngIf="!(isLoading$ | async)" class="grupos-grid">
      
      <!-- üìÅ Tarjetas de grupos compartidos -->
      <div 
        *ngFor="let grupo of SHARED_GRUPOS" 
        class="grupo-card-shared"
        (click)="goToTablero(grupo.id)"
      >
        <!-- Background image del grupo -->
        <div 
          class="grupo-card-bg"
          [style.background-image]="'url(' + getGrupoImageUrl(grupo.image) + ')'"
        ></div>
        
        <!-- Contenido de la tarjeta -->
        <div class="grupo-card-content">
          
          <!-- Header con nombre y opciones -->
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <h5 class="grupo-card-title text-white mb-1">
                {{ grupo.name }}
              </h5>
              
              <!-- Badge de nivel de permiso -->
              <span 
                class="badge fs-8"
                [ngClass]="getPermissionClass(grupo.user_permission)"
              >
                <i class="ki-duotone ki-lock-2 fs-6 me-1">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                {{ getPermissionLabel(grupo.user_permission) }}
              </span>
            </div>
            
            <!-- Opciones del grupo -->
            <div class="grupo-options">
              <button 
                class="btn btn-sm btn-icon btn-active-light-primary"
                (click)="toggleGrupoMenu(grupo.id, $event)"
                style="background: rgba(255,255,255,0.2);"
              >
                <i class="fa-solid fa-ellipsis-vertical" style="color: #ffffff;"></i>
              </button>

              <!-- Men√∫ desplegable del grupo -->
              <div 
                class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-200px py-4"
                [class.show]="openGrupoMenuId === grupo.id"
                style="position: absolute; right: 0; margin-top: 0.5rem; z-index: 105;"
              >
                <!-- ‚≠ê OPCI√ìN 1: Marcar como favorito -->
                <div class="menu-item px-3">
                  <a class="menu-link px-3" (click)="toggleStarGrupo(grupo, $event)">
                    <i class="ki-duotone ki-star fs-5 me-2" [class.text-warning]="grupo.is_starred">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                    {{ grupo.is_starred ? 'Desmarcar' : 'Marcar' }}
                  </a>
                </div>
                
                <!-- üë• OPCI√ìN 2: Ver miembros -->
                <div class="menu-item px-3">
                  <a class="menu-link px-3" (click)="shareGrupo(grupo, $event)">
                    <i class="fa-solid fa-users fs-5 me-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                    Ver miembros
                  </a>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Info del propietario y workspace -->
          <div class="grupo-info-owner mb-3">
            <div class="d-flex align-items-center gap-2">
              <div class="symbol symbol-25px symbol-circle">
                <img 
                  [src]="getAvatarUrl(grupo.user?.avatar)" 
                  [alt]="grupo.user?.name"
                />
              </div>
              <span class="text-white fs-7 opacity-75">
                Propietario: {{ grupo.user?.name || 'Desconocido' }}
              </span>
            </div>
            
            <!-- Workspace al que pertenece -->
            <div class="mt-2" *ngIf="grupo.workspace">
              <span class="badge badge-light fs-8">
                <i class="ki-duotone ki-folder fs-6 me-1">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                {{ grupo.workspace.name }}
              </span>
            </div>
          </div>
          
          <!-- Footer con miembros compartidos -->
          <div class="grupo-card-footer">
            
            <!-- Miembros -->
            <div class="d-flex align-items-center gap-2">
              <!-- Avatar del propietario -->
              <div class="symbol symbol-25px symbol-circle">
                <img 
                  [src]="getAvatarUrl(grupo.user?.avatar)" 
                  alt="Owner"
                />
              </div>
              
              <!-- Miembros adicionales -->
              <div class="symbol-group symbol-hover" *ngIf="grupo.shared_with && grupo.shared_with.length > 0">
                <div 
                  *ngFor="let member of grupo.shared_with.slice(0, 3)" 
                  class="symbol symbol-25px symbol-circle"
                >
                  <img 
                    [src]="getAvatarUrl(member.avatar)" 
                    [alt]="member.name"
                  />
                </div>
                
                <span 
                  *ngIf="grupo.shared_with.length > 3" 
                  class="symbol symbol-25px symbol-circle"
                >
                  <span class="symbol-label bg-light text-gray-600 fs-8">
                    +{{ grupo.shared_with.length - 3 }}
                  </span>
                </span>
              </div>
            </div>
            
            <!-- Indicador de favorito -->
            <div *ngIf="grupo.is_starred">
              <i class="ki-duotone ki-star fs-3 text-warning">
                <span class="path1"></span>
                <span class="path2"></span>
              </i>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- üì≠ Mensaje cuando no hay grupos compartidos -->
    <div 
      *ngIf="!(isLoading$ | async) && SHARED_GRUPOS.length === 0"
      class="text-center py-20"
    >
      <i class="ki-duotone ki-share fs-5x text-gray-300 mb-4">
        <span class="path1"></span>
        <span class="path2"></span>
      </i>
      <h3 class="text-gray-700 mb-2">No hay grupos compartidos</h3>
      <p class="text-gray-500">
        Cuando alguien comparta un grupo contigo, aparecer√° aqu√≠
      </p>
    </div>

  </div>
</div>

<!-- ========================================
     üë• MODAL DE MIEMBROS DEL GRUPO
     ======================================== -->
<div class="modal fade miembros-modal" id="miembrosModal" tabindex="-1" aria-labelledby="miembrosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      
      <!-- Header del Modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="miembrosModalLabel">
          <i class="fa-solid fa-users"></i>
          Miembros del Grupo: {{ selectedGrupo?.name }}
        </h5>
        <button type="button" class="btn-close" (click)="closeMiembrosModal()" aria-label="Close"></button>
      </div>
      
      <!-- Body del Modal -->
      <div class="modal-body">
        
        <!-- Contador de Miembros -->
        <div class="miembros-counter" *ngIf="miembrosGrupo && miembrosGrupo.length > 0">
          <div class="counter-text">
            <i class="fa-solid fa-users-line"></i>
            Total de miembros:
            <span class="counter-number">{{ miembrosGrupo.length }}</span>
          </div>
        </div>

        <!-- Loading -->
        <div class="text-center py-5" *ngIf="loadingMiembros">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-3 text-muted">Cargando miembros...</p>
        </div>

        <!-- Lista de Miembros -->
        <div class="miembros-list" *ngIf="!loadingMiembros && miembrosGrupo && miembrosGrupo.length > 0">
          
          <!-- Card del Propietario (siempre primero) -->
          <div class="miembro-card d-flex align-items-center gap-3" *ngIf="selectedGrupo?.user">
            <img 
              [src]="getUserAvatar()" 
              [alt]="'Avatar de ' + selectedGrupo.user.name"
              class="miembro-avatar" />
            
            <div class="miembro-info">
              <div class="miembro-nombre">
                {{ selectedGrupo.user.name }} {{ selectedGrupo.user.surname }}
                <span class="badge-owner">
                  <i class="fa-solid fa-crown"></i>
                  Propietario
                </span>
              </div>
              
              <div class="miembro-email">
                <i class="fa-solid fa-envelope"></i>
                <span>{{ selectedGrupo.user.email }}</span>
              </div>
              
              <div class="miembro-phone" *ngIf="selectedGrupo.user.phone">
                <i class="fa-solid fa-phone"></i>
                <span>{{ selectedGrupo.user.phone }}</span>
              </div>
            </div>
          </div>

          <!-- Cards de los Miembros Compartidos -->
          <div class="miembro-card d-flex align-items-center gap-3" *ngFor="let miembro of miembrosGrupo">
            <img 
              [src]="getMemberAvatar(miembro)" 
              alt="Avatar de {{ miembro.name }}"
              class="miembro-avatar">
            
            <div class="miembro-info">
              <div class="miembro-nombre">
                {{ miembro.name }} {{ miembro.surname }}
              </div>
              
              <div class="miembro-email">
                <i class="fa-solid fa-envelope"></i>
                <span>{{ miembro.email }}</span>
              </div>
              
              <div class="miembro-phone" *ngIf="miembro.phone">
                <i class="fa-solid fa-phone"></i>
                <span>{{ miembro.phone }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Estado Vac√≠o -->
        <div class="empty-state" *ngIf="!loadingMiembros && (!miembrosGrupo || miembrosGrupo.length === 0)">
          <div class="empty-icon">
            <i class="fa-solid fa-user-slash"></i>
          </div>
          <h4 class="empty-title">No hay miembros compartidos</h4>
          <p class="empty-text">Este grupo no ha sido compartido con otros usuarios todav√≠a.</p>
        </div>
      </div>
      
      <!-- Footer del Modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeMiembrosModal()">
          <i class="fa-solid fa-xmark me-1"></i>
          Cerrar
        </button>
      </div>
      
    </div>
  </div>
</div>