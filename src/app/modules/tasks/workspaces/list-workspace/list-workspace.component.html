<!-- ========================================
     ðŸ¢ VISTA DE ESPACIOS DE TRABAJO
     ======================================== -->
<div class="card">
  <!-- ðŸ” Barra de bÃºsqueda y acciones -->
  <div class="card-header border-0 pt-6">
    <div class="card-title">
      <div class="d-flex align-items-center position-relative my-1">
        <i class="ki-duotone ki-magnifier fs-1 position-absolute ms-6">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        <input 
          type="text" 
          class="form-control form-control-solid w-250px ps-15" 
          placeholder="Buscar espacios o grupos..."
          [(ngModel)]="search"
          (keyup.enter)="loadWorkspaces()"
        />
      </div>
    </div>

    <div class="card-toolbar">
      <button 
        type="button" 
        class="btn btn-primary"
        (click)="createWorkspace()"
      >
        <i class="ki-duotone ki-plus fs-2"></i>
        Nuevo Espacio de Trabajo
      </button>
    </div>
  </div>

  <!-- ðŸ“‹ Lista de Workspaces -->
  <div class="card-body pt-0">
    
    <!-- â³ Loading State -->
    <div *ngIf="isLoading$ | async" class="text-center py-10">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="text-muted mt-3">Cargando espacios de trabajo...</p>
    </div>

    <!-- ðŸ“‚ Workspaces Container -->
    <div *ngIf="!(isLoading$ | async)" class="workspaces-container">
      
      <!-- ðŸ“ Iterar sobre cada workspace -->
      <div 
        *ngFor="let workspace of WORKSPACES" 
        class="workspace-section mb-8"
      >
        
        <!-- ðŸ“Œ Encabezado del Workspace -->
        <div class="workspace-header d-flex align-items-center justify-content-between mb-4">
          
          <div class="d-flex align-items-center gap-3">
            <!-- Icono del workspace -->
            <div 
              class="workspace-icon-preview"
              [style.background-color]="getWorkspaceColor(workspace)"
            >
              <i 
                class="ki-duotone fs-2x text-white"
                [ngClass]="{
                  'ki-home': workspace.is_general,
                  'ki-share': workspace.is_shared,
                  'ki-folder': !workspace.is_general && !workspace.is_shared
                }"
              >
                <span class="path1"></span>
                <span class="path2"></span>
              </i>
            </div>

            
            <!-- Nombre y descripciÃ³n -->
            <div>
              <h3 class="mb-0 d-flex align-items-center gap-2">
                {{ workspace.name }}
                
                <!-- Badge para workspace general o compartido -->
                <span 
                  *ngIf="workspace.is_general" 
                  class="badge badge-light-primary"
                >
                  Principal
                </span>
                <span 
                  *ngIf="workspace.is_shared" 
                  class="badge badge-light-success"
                >
                  Compartidos
                </span>
              </h3>
              
              <p class="text-muted mb-0 fs-7" *ngIf="workspace.description">
                {{ workspace.description }}
              </p>
              
              <!-- Contador de grupos -->
              <p class="text-muted mb-0 fs-8 mt-1">
                <i class="ki-duotone ki-folder fs-7 me-1">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                {{ workspace.grupos?.length || 0 }} grupo(s)
              </p>
            </div>
          </div>
          
          <div class="d-flex align-items-center gap-2">
            
            <!-- âœ… BotÃ³n "Ver todos" si hay grupos -->
            <button 
              *ngIf="workspace.grupos && workspace.grupos.length > 0"
              class="btn btn-sm btn-light-primary"
              (click)="goToWorkspaceGroups(workspace.id, $event)"
            >
              <i class="ki-duotone ki-eye fs-4 me-1">
                <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
              </i>
              Ver todos los grupos
            </button>
            
            <!-- ðŸ”§ Opciones del workspace -->
            <div class="workspace-options" *ngIf="!workspace.is_general && !workspace.is_shared">
              <button 
                class="btn btn-sm btn-icon btn-light btn-active-light-primary"
                (click)="toggleWorkspaceMenu(workspace.id, $event)"
              >
                <i class="fa-solid fa-ellipsis-vertical fs-2">
                  <span class="path1"></span>
                  <span class="path2"></span>
                  <span class="path3"></span>
                </i>
              </button>

              <!-- MenÃº desplegable -->
              <div 
                class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-200px py-4"
                [class.show]="openWorkspaceMenuId === workspace.id"
                style="position: absolute; right: 0; margin-top: 0.5rem; z-index: 105;"
              >
                <div class="menu-item px-3">
                  <a class="menu-link px-3" (click)="editWorkspace(workspace, $event)">
                    <i class="ki-duotone ki-pencil fs-5 me-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                    Editar espacio
                  </a>
                </div>
                
                <div class="menu-item px-3">
                  <a class="menu-link px-3 text-danger" (click)="deleteWorkspace(workspace, $event)">
                    <i class="ki-duotone ki-trash fs-5 me-2">
                      <span class="path1"></span>
                      <span class="path2"></span>
                      <span class="path3"></span>
                      <span class="path4"></span>
                      <span class="path5"></span>
                    </i>
                    Eliminar espacio
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ðŸ“ Grupos del Workspace (Scroll Horizontal) -->
        <div class="grupos-horizontal-scroll">
          <div class="grupos-scroll-container">
            
            <!-- ðŸ“ Tarjetas de grupos (mÃ¡ximo 6 para preview) -->
            <div 
              *ngFor="let grupo of workspace.grupos?.slice(0, 6)" 
              class="grupo-card"
              (click)="goToTablero(grupo.id)"
            >
              <!-- Background image -->
              <div 
                class="grupo-card-bg"
                [style.background-image]="'url(' + getGrupoImageUrl(grupo.image) + ')'"
              ></div>
              
              <!-- Contenido de la tarjeta -->
              <div class="grupo-card-content">
                
                <!-- Header con nombre y opciones -->
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="grupo-card-title text-white mb-0">
                    {{ grupo.name }}
                  </h5>
                  
                  <!-- Opciones del grupo -->
                  <div class="grupo-options">
                    <button 
                      class="btn btn-sm btn-icon btn-active-light-primary"
                      (click)="toggleGrupoMenu(grupo.id, $event)"
                      style="background: rgba(255,255,255,0.2);"
                    >
                      <i class="fa-solid fa-ellipsis-vertical" style="color: #ffffff;"></i>
                    </button>

                    <!-- MenÃº desplegable del grupo -->
                    <div 
                      class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-200px py-4"
                      [class.show]="openGrupoMenuId === grupo.id"
                      style="position: absolute; right: 0; margin-top: 0.5rem; z-index: 105;"
                    >
                      <div class="menu-item px-3">
                        <a class="menu-link px-3" (click)="toggleStarGrupo(grupo, $event)">
                          <i class="ki-duotone ki-star fs-5 me-2" [class.text-warning]="grupo.is_starred">
                            <span class="path1"></span>
                            <span class="path2"></span>
                          </i>
                          {{ grupo.is_starred ? 'Desmarcar' : 'Marcar' }}
                        </a>
                      </div>
                      
                      <div class="menu-item px-3" *ngIf="grupo.is_owner">
                        <a class="menu-link px-3" (click)="shareGrupo(grupo, $event)">
                          <i class="fa-solid fa-share-nodes fs-5 me-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                          </i>
                          Compartir
                        </a>
                      </div>
                      
                      <div class="menu-item px-3" *ngIf="grupo.is_owner">
                        <a class="menu-link px-3" (click)="configPermisosGrupo(grupo, $event)">
                          <i class="ki-duotone ki-lock fs-5 me-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                          </i>
                          Permisos
                        </a>
                      </div>
                      
                      <div class="separator my-2"></div>
                      
                      <div class="menu-item px-3">
                        <a class="menu-link px-3" (click)="editGrupo(grupo, $event)">
                          <i class="ki-duotone ki-pencil fs-5 me-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                          </i>
                          Editar
                        </a>
                      </div>
                      
                      <div class="menu-item px-3" *ngIf="grupo.is_owner">
                        <a class="menu-link px-3 text-danger" (click)="deleteGrupo(grupo, $event)">
                          <i class="ki-duotone ki-trash fs-5 me-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                            <span class="path4"></span>
                            <span class="path5"></span>
                          </i>
                          Eliminar
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Footer con info adicional -->
                <div class="grupo-card-footer">
                  
                  <!-- Miembros -->
                  <div class="d-flex align-items-center gap-2">
                    <!-- Avatar del propietario -->
                    <div class="symbol symbol-25px symbol-circle">
                      <img 
                        [src]="getAvatarUrl(grupo.user?.avatar)" 
                        alt="Owner"
                      />
                    </div>
                    
                    <!-- Miembros adicionales -->
                    <div class="symbol-group symbol-hover" *ngIf="grupo.shared_with && grupo.shared_with.length > 0">
                      <div 
                        *ngFor="let member of grupo.shared_with.slice(0, 3)" 
                        class="symbol symbol-25px symbol-circle"
                      >
                        <img 
                          [src]="getAvatarUrl(member.avatar)" 
                          [alt]="member.name"
                        />
                      </div>
                      
                      <span 
                        *ngIf="grupo.shared_with.length > 3" 
                        class="symbol symbol-25px symbol-circle"
                      >
                        <span class="symbol-label bg-light text-gray-600 fs-8">
                          +{{ grupo.shared_with.length - 3 }}
                        </span>
                      </span>
                    </div>
                  </div>
                  
                  <!-- Indicador de favorito -->
                  <div *ngIf="grupo.is_starred">
                    <i class="ki-duotone ki-star fs-3 text-warning">
                      <span class="path1"></span>
                      <span class="path2"></span>
                    </i>
                  </div>
                </div>
              </div>
            </div>

            <!-- âž• Tarjeta para agregar nuevo grupo -->
            <div 
              class="grupo-card grupo-card-add"
              (click)="createGrupoInWorkspace(workspace, $event)"
            >
              <div class="grupo-card-add-content">
                <i class="ki-duotone ki-plus fs-3x text-gray-400 mb-3">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                <p class="text-gray-600 mb-0">Agregar Grupo</p>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>

    <!-- ðŸ”­ Mensaje cuando no hay workspaces -->
    <div 
      *ngIf="!(isLoading$ | async) && (!WORKSPACES || WORKSPACES.length === 0)"
      class="text-center py-20"
    >
      <i class="ki-duotone ki-home-2 fs-5x text-gray-300 mb-4">
        <span class="path1"></span>
        <span class="path2"></span>
      </i>
      <h3 class="text-gray-700 mb-2">No hay espacios de trabajo</h3>
      <p class="text-gray-500 mb-5">Comienza creando tu primer espacio para organizar tus proyectos</p>
      <button 
        class="btn btn-primary"
        (click)="createWorkspace()"
      >
        <i class="ki-duotone ki-plus fs-2 me-1">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        Crear Espacio de Trabajo
      </button>
    </div>

  </div>
</div>