<div class="container-fluid py-4" 
     [ngStyle]="{
       'background-image': GRUPO_SELECTED?.image ? 'url(assets/media/fondos/' + GRUPO_SELECTED.image + ')' : 'none',
       'background-size': 'cover',
       'background-position': 'center',
       'background-attachment': 'fixed',
       'min-height': '100vh'
     }">
   <!-- Loading spinner -->
  <span class="spinner-border spinner-border-sm align-middle ms-2" *ngIf="isLoading$ | async"></span>
    
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
      <button class="btn btn-sm btn-light me-3" (click)="volverAGrupos()">
        <i class="fa-solid fa-arrow-left me-2"></i> Volver
      </button>
      
      <div *ngIf="GRUPO_SELECTED">
        <h4 class="fw-bold mb-0">
          <span 
            class="badge me-2" 
            [style.background-color]="GRUPO_SELECTED.color || '#6c757d'">
          </span>
          {{ GRUPO_SELECTED.name }}
        </h4>
        <p class="text-muted small mb-0">Tablero de tareas</p>
      </div>
      
      <div *ngIf="!GRUPO_SELECTED" class="d-flex align-items-center">
        <span class="spinner-border spinner-border-sm me-2"></span>
        <span class="text-muted">Cargando grupo...</span>
      </div>
    </div>

    <!-- ‚úÖ Solo mostrar bot√≥n de a√±adir lista si tiene permisos de escritura -->
    <button 
        *ngIf="permissionsLoaded && hasWriteAccess" 
        class="btn btn-primary" 
        (click)="createLista()">
        <i class="fa-solid fa-plus me-2"></i> A√±adir lista
    </button>

    <!-- ‚úÖ Badge de solo lectura - mostrar solo cuando los permisos est√©n cargados -->
    <div *ngIf="permissionsLoaded && !hasWriteAccess && !isOwner" class="alert alert-warning d-flex align-items-center mb-0">
        <i class="fa-solid fa-eye me-2"></i>
        <span>Solo tienes permisos de lectura en este grupo</span>
    </div>
  </div>

  <!-- Loading spinner general -->
  <div *ngIf="isLoading$ | async" class="d-flex justify-content-center py-5">
    <span class="spinner-border spinner-border-lg text-primary"></span>
  </div>

  <!-- ‚úÖ TABLERO CON SISTEMA DE SNAP - Deshabilitado si no tiene permisos -->
  <div 
    [cdkDropListDisabled]="!hasWriteAccess"
    cdkDropList
    cdkDropListOrientation="horizontal"
    (cdkDropListDropped)="onListDrop($event)"
    class="kanban-container-snap pb-3" 
    *ngIf="!(isLoading$ | async) && permissionsLoaded">
    
    <!-- Lista vac√≠a -->
    <div *ngIf="LISTAS.length === 0" class="text-center py-5 w-100">
      <i class="fa-solid fa-clipboard-list fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">No hay listas en este grupo</h5>
      <p class="text-muted small">
        <span *ngIf="hasWriteAccess">Crea tu primera lista para comenzar a organizar tus tareas</span>
        <span *ngIf="!hasWriteAccess">Este grupo a√∫n no tiene listas</span>
      </p>
      <!-- ‚úÖ Solo mostrar bot√≥n si tiene permisos -->
      <button 
        *ngIf="hasWriteAccess" 
        class="btn btn-primary mt-3" 
        (click)="createLista()">
        <i class="fa-solid fa-plus me-2"></i> Crear primera lista
      </button>
    </div>

    <!-- ‚úÖ Listas con tareas (con snap grid) -->
    <div 
      *ngFor="let LISTA of LISTAS; let i = index" 
      [cdkDragDisabled]="!hasWriteAccess"
      cdkDrag
      class="kanban-list-snap">
      
      <div class="card bg-light border-0 shadow-sm h-100">
        
        <!-- HEADER DE LISTA -->
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          
          <h5 class="fw-bold text-dark mb-0" [ngClass]="{'cursor-move': hasWriteAccess}">
            <i *ngIf="hasWriteAccess" class="fa-solid fa-grip-vertical text-muted me-2"></i>
            <i *ngIf="!hasWriteAccess" class="fa-solid fa-list text-muted me-2"></i>
            {{ LISTA.name }}
            <span class="badge bg-secondary ms-2">{{ LISTA.tareas?.length || 0 }}</span>
          </h5>

          <!-- ‚úÖ Men√∫ de opciones de lista - Solo mostrar si tiene permisos de escritura -->
          <div class="card-toolbar position-relative" *ngIf="hasWriteAccess">
              <button
                  class="btn btn-sm btn-icon btn-color-primary btn-active-light-primary"
                  (click)="toggleMenu(i, $event)">
                  <i class="fa-solid fa-ellipsis-vertical"></i>
              </button>

              <div 
                  *ngIf="openMenuId === i"
                  class="menu-dropdown bg-white border rounded shadow position-absolute end-0 mt-2 p-3 zindex-dropdown"
                  style="min-width: 200px; z-index: 1000;">
                  
                  <div class="fs-6 fw-bold text-gray-900 mb-2">Opciones</div>
                  <ul class="list-unstyled mb-0">
                      <li class="mb-2">
                          <button 
                              type="button"
                              class="btn btn-link text-decoration-none fw-bold text-dark d-block w-100 text-start p-2 rounded"
                              (click)="closeMenuAnd('editLista', LISTA)">
                              <i class="fa-solid fa-pen-to-square me-2 text-primary"></i> Editar lista
                          </button>
                      </li>
                      <li>
                          <button 
                              type="button"
                              class="btn btn-link text-decoration-none fw-bold text-danger d-block w-100 text-start p-2 rounded"
                              (click)="closeMenuAnd('deleteLista', LISTA)">
                              <i class="fa-solid fa-trash me-2"></i> Eliminar lista
                          </button>
                      </li>
                  </ul>
              </div>
          </div>
        </div>

        <!-- ‚úÖ BOT√ìN PARA AGREGAR TAREA - Solo mostrar si tiene permisos de escritura -->
        <div class="card-body border-0 shadow-sm p-3 bg-white mb-3" *ngIf="hasWriteAccess">
            <button
                type="button"
                class="btn btn-light w-100 text-dark border"
                (click)="createTarea(LISTA.id)">
                <i class="fa-solid fa-plus me-2"></i> Agregar Tarea
            </button>
        </div>

        <!-- ‚úÖ CONTENEDOR DE TAREAS (Drag & Drop entre listas - deshabilitado si no tiene permisos) -->
        <div
          cdkDropList
          [cdkDropListData]="LISTA.tareas"
          [id]="'lista-' + LISTA.id"
          [cdkDropListConnectedTo]="getConnectedLists()"
          [cdkDropListDisabled]="!hasWriteAccess"
          class="card-body pt-0"
          style="min-height: 200px;"
          (cdkDropListDropped)="onTaskDrop($event, LISTA)">
          
          <!-- Tareas arrastrables -->
          <div
            *ngFor="let TAREA of LISTA.tareas; let taskIndex = index"
            [cdkDragDisabled]="!hasWriteAccess"
            cdkDrag
            [cdkDragData]="TAREA"
            class="card mb-3 border-0 shadow-sm bg-white tarea-card"
            [class.tarea-expanded]="TAREA.expanded"
            [class.border-progreso]="TAREA.status === 'en_progreso'"
            [class.border-completada]="TAREA.status === 'completada'">

            <!-- üÜï Encabezado con l√≠neas de colores de etiquetas -->
            <div class="etiquetas-header" *ngIf="TAREA.etiquetas && TAREA.etiquetas.length > 0">
              <div 
                *ngFor="let etiqueta of TAREA.etiquetas" 
                class="etiqueta-line"
                [style.background-color]="etiqueta.color">
              </div>
            </div>
            
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-start">
                <!-- Contenido de la tarea -->
                <div class="flex-grow-1 cursor-pointer tarea-content" (click)="editTarea(TAREA)">
                  <h6 class="fw-bold mb-2 tarea-title">{{ TAREA.name }}</h6>
                  
                  <!-- Descripci√≥n con l√≠mite de 30 caracteres -->
                  <div *ngIf="TAREA.description" class="mb-2">
                    <p class="text-muted small mb-0 tarea-description">
                      <ng-container *ngIf="!TAREA.expanded">
                        {{ TAREA.description.length > 30 ? (TAREA.description | slice:0:30) + '...' : TAREA.description }}
                      </ng-container>
                      <ng-container *ngIf="TAREA.expanded">
                        {{ TAREA.description }}
                      </ng-container>
                    </p>
                  </div>

                  <!-- Badges de informaci√≥n -->
                  <div class="d-flex flex-wrap gap-2 mb-2">
                    

                    <span 
                      class="badge badge-sm"
                      [ngClass]="{
                        'bg-success': TAREA.status === 'completada',
                        'bg-warning': TAREA.status === 'en_progreso',
                        'bg-secondary': TAREA.status === 'pendiente'
                      }">
                      {{ TAREA.status === 'completada' ? 'Completada' : TAREA.status === 'en_progreso' ? 'En progreso' : 'Pendiente' }}
                    </span>

                    <span class="badge badge-sm bg-light text-dark" *ngIf="TAREA.due_date">
                      <i class="fa-solid fa-calendar fa-xs me-1"></i>
                      {{ TAREA.due_date | date: 'dd MMM'}}
                    </span>
                  </div>

                  <!-- üÜï Pie de p√°gina con indicadores -->
                  <div class="tarea-footer" *ngIf="tieneIndicadores(TAREA)">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center gap-3">
                        <!-- Indicador de adjuntos -->
                        <div 
                          class="footer-indicator" 
                          *ngIf="getTotalAdjuntos(TAREA) > 0"
                          title="Adjuntos">
                          <i class="fa-solid fa-paperclip"></i>
                          <span>{{ getTotalAdjuntos(TAREA) }}</span>
                        </div>

                        <!-- Indicador de checklist -->
                        <div 
                          class="footer-indicator"
                          *ngIf="getTotalChecklistItems(TAREA) > 0"
                          [class.checklist-completed]="isChecklistCompleted(TAREA)"
                          [title]="getChecklistProgress(TAREA) + '% completado'">
                          <i class="fa-solid fa-check-square"></i>
                          <span>{{ getCompletedChecklistItems(TAREA) }}/{{ getTotalChecklistItems(TAREA) }}</span>
                        </div>

                        <!-- Indicador de comentarios -->
                        <div 
                          class="footer-indicator" 
                          *ngIf="getTotalComentarios(TAREA) > 0"
                          title="Comentarios">
                          <i class="fa-solid fa-comment"></i>
                          <span>{{ getTotalComentarios(TAREA) }}</span>
                        </div>
                      </div>

                      <!-- Avatar del usuario asignado -->
                      <div class="d-flex align-items-center gap-2 mt-2" *ngIf="TAREA.assigned_members && TAREA.assigned_members.length > 0">
                        <div class="members-avatars">
                          <div 
                            *ngFor="let member of TAREA.assigned_members.slice(0, 3)" 
                            class="member-avatar-wrapper"
                            [title]="member.name + ' ' + (member.surname || '')">
                            <img 
                              [src]="getMemberAvatar(member)" 
                              [alt]="member.name"
                              class="member-avatar">
                          </div>
                          <div 
                            *ngIf="TAREA.assigned_members.length > 3" 
                            class="member-avatar-more"
                            [title]="'+ ' + (TAREA.assigned_members.length - 3) + ' miembro(s) m√°s'">
                            <span>+{{ TAREA.assigned_members.length - 3 }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>

                <!-- ‚úÖ Botones de acci√≥n - Solo mostrar si tiene permisos -->
                <div class="d-flex flex-column gap-2 ms-2 tarea-actions" *ngIf="hasWriteAccess">
                  <button 
                    *ngIf="TAREA.description && TAREA.description.length > 30"
                    type="button"
                    class="btn btn-sm btn-icon btn-light btn-expand"
                    (click)="toggleTaskExpand(TAREA, $event)"
                    [title]="TAREA.expanded ? 'Contraer' : 'Expandir'">
                    <i 
                      class="fa-solid transition-icon"
                      [class.fa-chevron-down]="!TAREA.expanded"
                      [class.fa-chevron-up]="TAREA.expanded"></i>
                  </button>

                  <button 
                    type="button"
                    class="btn btn-sm btn-icon btn-light btn-delete"
                    (click)="deleteTarea(TAREA, $event)"
                    title="Eliminar tarea">
                    <i class="fa-solid fa-trash-can"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Mensaje cuando no hay tareas -->
          <div 
            *ngIf="!LISTA.tareas || LISTA.tareas.length === 0" 
            class="text-center text-muted mt-4 py-5">
            <i class="fa-solid fa-inbox fa-2x mb-2 opacity-50"></i>
            <p class="small">Sin tareas</p>
            <p class="small text-muted" *ngIf="hasWriteAccess">Arrastra tareas aqu√≠ o crea una nueva</p>
            <p class="small text-muted" *ngIf="!hasWriteAccess">No hay tareas en esta lista</p>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>