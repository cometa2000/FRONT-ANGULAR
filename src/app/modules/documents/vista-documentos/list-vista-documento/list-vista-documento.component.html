<div class="card">
  <!-- Card header -->
  <div class="card-header border-0 pt-6">
    <!-- Card title con breadcrumb -->
    <div class="card-title flex-column align-items-start">
      <!-- Breadcrumb -->
      <div class="d-flex align-items-center mb-3">
        <button 
          *ngIf="breadcrumb.length > 1"
          class="btn btn-icon btn-light btn-sm me-3"
          (click)="goBack()"
          title="Volver">
          <i class="ki-duotone ki-arrow-left fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
          </i>
        </button>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb breadcrumb-line text-muted fs-6 fw-semibold mb-0">
            <li class="breadcrumb-item" *ngFor="let item of breadcrumb; let i = index; let last = last">
              <a 
                *ngIf="!last"
                href="#" 
                onclick="return false;"
                (click)="navigateToBreadcrumb(i)"
                class="text-muted text-hover-primary">
                <i class="ki-duotone ki-home fs-3 me-1" *ngIf="i === 0">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                {{ item.name }}
              </a>
              <span *ngIf="last" class="text-gray-800 fw-bold">
                <i class="ki-duotone ki-home fs-3 me-1" *ngIf="i === 0">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                {{ item.name }}
              </span>
            </li>
          </ol>
        </nav>
      </div>

      <!-- Búsqueda -->
      <div class="d-flex align-items-center position-relative">
        <i class="ki-duotone ki-magnifier fs-3 position-absolute ms-5">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        <input 
          type="text" 
          [(ngModel)]="search" 
          (keyup.enter)="listDocumentos()" 
          name="search"
          class="form-control form-control-solid w-300px ps-12" 
          placeholder="Buscar documentos...">
      </div>
    </div>

    <span class="spinner-border spinner-border-sm align-middle ms-2" *ngIf="isLoading$ | async"></span>

    <!-- Card toolbar -->
    <div class="card-toolbar">
      <!-- Botón Nueva Carpeta -->
      <button 
        type="button" 
        class="btn btn-light-primary me-2"
        (click)="createFolder()">
        <i class="ki-duotone ki-folder-added fs-2">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        Nueva Carpeta
      </button>

      <!-- Botón Subir Documento -->
      <button 
        type="button" 
        class="btn btn-primary"
        (click)="uploadDocumento()">
        <i class="ki-duotone ki-file-up fs-2">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        Subir Documento(s)
      </button>
    </div>
  </div>

  <!-- Card body -->
  <div class="card-body pt-0">
    
    <!-- Tabla de documentos -->
    <div class="table-responsive">
      <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
        <!-- Encabezados -->
        <thead>
          <tr class="fw-bold text-muted">
            <th class="w-50px"></th>
            <th class="min-w-300px cursor-pointer" (click)="sortBy('name')">
              Nombre
              <i class="ki-duotone ki-arrow-up fs-7 ms-1" *ngIf="sortColumn === 'name' && sortDirection === 'asc'"></i>
              <i class="ki-duotone ki-arrow-down fs-7 ms-1" *ngIf="sortColumn === 'name' && sortDirection === 'desc'"></i>
            </th>
            <th class="min-w-150px cursor-pointer" (click)="sortBy('user')">
              Propietario
              <i class="ki-duotone ki-arrow-up fs-7 ms-1" *ngIf="sortColumn === 'user' && sortDirection === 'asc'"></i>
              <i class="ki-duotone ki-arrow-down fs-7 ms-1" *ngIf="sortColumn === 'user' && sortDirection === 'desc'"></i>
            </th>
            <th class="min-w-150px cursor-pointer" (click)="sortBy('updated_at')">
              Fecha de modificación
              <i class="ki-duotone ki-arrow-up fs-7 ms-1" *ngIf="sortColumn === 'updated_at' && sortDirection === 'asc'"></i>
              <i class="ki-duotone ki-arrow-down fs-7 ms-1" *ngIf="sortColumn === 'updated_at' && sortDirection === 'desc'"></i>
            </th>
            <th class="min-w-100px cursor-pointer" (click)="sortBy('size')">
              Tamaño
              <i class="ki-duotone ki-arrow-up fs-7 ms-1" *ngIf="sortColumn === 'size' && sortDirection === 'asc'"></i>
              <i class="ki-duotone ki-arrow-down fs-7 ms-1" *ngIf="sortColumn === 'size' && sortDirection === 'desc'"></i>
            </th>
            <th class="min-w-100px text-end">Acciones</th>
          </tr>
        </thead>

        <!-- Cuerpo de la tabla -->
        <tbody>
          <tr *ngFor="let DOCUMENTO of sortedDocumentos" class="documento-row">
            <!-- Ícono -->
            <td>
              <div class="symbol symbol-45px">
                <div 
                  class="symbol-label"
                  [ngClass]="DOCUMENTO.type === 'folder' ? 'bg-light-warning' : getFileIconClass(DOCUMENTO)">
                  <i 
                    [class]="getFileIcon(DOCUMENTO) + ' fs-2x'"
                    [ngClass]="getFileIconColor(DOCUMENTO)">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span *ngIf="DOCUMENTO.type === 'folder'" class="path3"></span>
                  </i>
                </div>
              </div>
            </td>

            <!-- Nombre con badge "new" si aplica -->
            <td>
              <a 
                href="#" 
                onclick="return false;"
                (click)="viewDocumento(DOCUMENTO)"
                class="text-gray-800 text-hover-primary fw-bold fs-6">
                {{ DOCUMENTO.name }}
              </a>
              
              <!-- Badge NEW -->
              <span 
                class="badge badge-sm badge-light-primary ms-2"
                *ngIf="DOCUMENTO.is_new">
                Nuevo
              </span>

              <!-- Info de carpeta -->
              <div class="text-muted fs-7 mt-1" *ngIf="DOCUMENTO.type === 'folder'">
                {{ DOCUMENTO.files_count || 0 }} archivo(s)
              </div>
            </td>

            <!-- Propietario -->
            <td>
              <div class="d-flex align-items-center">
                <div class="symbol symbol-30px me-3">
                  <div class="symbol-label bg-light-primary">
                    <span class="text-primary fw-bold fs-7">
                      {{ getInitials(DOCUMENTO.user?.name, DOCUMENTO.user?.surname) }}
                    </span>
                  </div>
                </div>
                <div class="d-flex flex-column">
                  <span class="text-gray-800 fs-7 fw-semibold">
                    {{ DOCUMENTO.user?.name }} {{ DOCUMENTO.user?.surname }}
                  </span>
                </div>
              </div>
            </td>

            <!-- Fecha de modificación -->
            <td>
              <span class="text-gray-600 fs-7">
                {{ DOCUMENTO.updated_at }}
              </span>
            </td>

            <!-- Tamaño -->
            <td>
              <span class="text-gray-600 fs-7">
                <ng-container *ngIf="DOCUMENTO.type === 'file'">
                  {{ DOCUMENTO.size_formatted }}
                </ng-container>
                <ng-container *ngIf="DOCUMENTO.type === 'folder'">
                  —
                </ng-container>
              </span>
            </td>

            <!-- Acciones -->
            <td class="text-end">
              <!-- Botón Mover -->
              <button
                class="btn btn-icon btn-light-primary btn-sm me-1"
                (click)="moveDocumento(DOCUMENTO); $event.stopPropagation()"
                title="Mover">
                <i class="ki-duotone ki-arrow-right-left fs-2">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
              </button>

              <!-- Botón Eliminar (condicional) -->
              <button
                *ngIf="canDelete(DOCUMENTO)"
                class="btn btn-icon btn-light-danger btn-sm"
                (click)="deleteDocumento(DOCUMENTO); $event.stopPropagation()"
                title="Eliminar">
                <i class="ki-duotone ki-trash fs-2">
                  <span class="path1"></span>
                  <span class="path2"></span>
                  <span class="path3"></span>
                  <span class="path4"></span>
                  <span class="path5"></span>
                </i>
              </button>
            </td>
          </tr>

          <!-- Mensaje si no hay documentos -->
          <tr *ngIf="DOCUMENTOS.length === 0">
            <td colspan="6" class="text-center py-10">
              <div class="d-flex flex-column align-items-center">
                <i class="ki-duotone ki-folder fs-5x text-gray-400 mb-5">
                  <span class="path1"></span>
                  <span class="path2"></span>
                </i>
                <h3 class="text-gray-600">Esta carpeta está vacía</h3>
                <p class="text-muted">Crea una nueva carpeta o sube archivos</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>